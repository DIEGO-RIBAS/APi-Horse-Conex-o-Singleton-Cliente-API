unit uModel.Login;

interface

  uses System.SysUtils, System.JSON, IPPeerClient, system.Classes,
       RESTRequest4D,
       DataSet.Serialize.Adapter.RESTRequest4D,
       FireDAC.Comp.Client, FireDAC.Dapt;

  type

    TModelLogin = class
      private
        FLongin : string;
        FPass   : string;

        FQuery  : TFDQuery;
      public
         property Longin : string read FLongin write FLongin;
         property Pass   : string read FPass   write FPass;

         function Validar : Integer;

         constructor create;
         destructor dstroy;

    end;

implementation

{ TModelLogin }

constructor TModelLogin.create;
begin
  FQuery := TFDQuery.Create(nil);
end;

destructor TModelLogin.dstroy;
begin
  FreeAndNil(FQuery);
end;

function TModelLogin.Validar: Integer;
var
  Resp      : IResponse;
  JsonLogin : TJSONObject;
  JsonAPI   : TJSONObject;
begin
  JsonLogin := TJSONObject.Create;
  try
    JsonLogin.AddPair('Login',FLongin);
    JsonLogin.AddPair('Pass',FPass);

    Resp := TRequest.New.BaseURL('localhost:9000/')
                                .Resource('Validar')
                                .Accept('application/json')
                             //   .Adapters(TDataSetSerializeAdapter.New(FQuery))
                                .AddBody(JsonLogin)
                                .Post;

    if Resp.StatusCode = 200 then
    begin
      JsonAPI := TJSONObject.ParseJSONValue(TEncoding.UTF8.GetBytes(Resp.Content),0) as TJSONObject;

      if not StrToBool(JsonAPI.GetValue('Erro').Value) then
      begin
        Result := StrToInt(JsonAPI.GetValue('Usuario').Value);
      end
       else
         begin
           Result := 0;
         end;
    end;
  finally
//    FreeAndNil(JsonLogin);
  end;


end;

end.
